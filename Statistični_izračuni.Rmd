---
title: "Priloga - Statistični izračuni"
author: "Luka Štrlekar"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Izračuni za številske (intervalne) spremnljivke

## Neuteženi podatki

Želimo primerjati povprečja ($\mu_1$ in $\mu_2)$ iz dveh neodvisnih vzorcev (skupin) in ugotoviti ali se na populaciji razlikujeta. Ničelna domneva je $H_0: \mu_1=\mu_2$, torej, da sta povprečji enaki. Za preverjanje slednje ničelne domneve uporabimo *t-test* za neenake variance (t.i. *Welchev t-test*), ki med drugim predpostavlja normalno porazdelitev povprečji v obeh skupinah oziroma dovolj velik vzorec (v vsaki skupini), da velja centralni limitni izrek (običajno pravilo čez palec $n \geq 30$).

Ker sta vzorca neodvisna, velja $Var(\mu_1 - \mu_2) = \frac{\sigma^2_1}{n_1} + \frac{\sigma^2_2}{n_2}$. Na vzorcu ocenimo testno statistiko:

\begin{equation}
T = \frac{\hat{\mu}_1 - \hat{\mu}_2}{\sqrt{\frac{{\hat\sigma}^2_1}{n_1} + \frac{\hat{\sigma}^2_2}{n_2}}} 
\end{equation}
ki je približno porazdeljena po $t$ porazdelitvi z $\nu$ stopinjami prostosti (df) izračunanimi po naslednji formuli:

$$
\nu \approx \dfrac{\left(\hat{\sigma}_{1}^{2} / n_{1}+\hat{\sigma}_{2}^{2} / n_{2}\right)^{2}}{\left(\hat{\sigma}_{1}^{2} / n_{1}\right)^{2} /\left(n_{1}-1\right)+\left(\hat{\sigma}_{2}^{2} / n_{2}\right)^{2} /\left(n_{2}-1\right)}
$$
Pogosto prakso, ki je npr. implementirana v SPSS, da se najprej preveri enakost varianc (npr. z Levenovim testom) in nato uporabi ustrezen t-test (z enakimi ali neenakimi variancami), se odsvetuje.

## Uteženi podatki

Utežujemo s poststratifikacijskimi utežmi, uteži so normalizirane (povprečje uteži je 1 in vsota uteži je enaka velikosti vzorca $\sum^n_{i=1}w_i=n$). 

Vzorčno uteženo aritmetično sredino lahko v splošnem zapišemo (Kalton & Vehovar, 2001, str. 93):

\begin{equation}
\hat{\mu}_w = \frac{\sum^n_{i=1} w_i x_i}{\sum^n_{i=1} w_i}
\end{equation}

Oglejmo si še oceno vzorčne variance. Ker ima utežena aritmetična sredina slučajni spremenljivki v števcu in v imenovalcu, moramo uporabiti izraz za varianco razmernostne cenilke. Če je koeficient variacije uteži manjši od 0.2, je približna cenilka variance za uteženo aritmetično sredino enaka (pri čemer je spremenljivka $u_i$ definirana kot $u_i = w_ix_i$ ter je $n$ velikost vzorca) (Kalton & Vehovar, 2001, str. 95):

\begin{equation}
var(\hat{\mu}_w) \approx \frac{var(u) n + \hat{\mu}_w^2 var(w) n - 2 \hat{\mu}_w  cov(u,w) n}{(\sum^n_{i=1} w_i)^2}
\end{equation}

Ker so uteži normalizirane ($\sum^n_{i=1} w_i=n$), se enačba (3) poenostavi v:

\begin{equation}
var(\hat{\mu}_w) \approx \frac{var(u) + \hat{\mu}_w^2 var(w) - 2 \hat{\mu}_w  cov(u,w)}{n}
\end{equation}

V praksi sicer prevladuje prepričanje, da je vpliv obravnavane korelacije majhen, saj običajno ni posebnih razlogov za izrazitejšo povezanost med utežmi in vrednostmi spremenljivk, pa tudi vpliv korelacije ni neposreden, ampak je precej kompleksen. Po drugi strani velja opozoriti, da je korelacija med utežmi in spremenljivko - na nivoju celotnega vzorca - predpogoj za nastanek in tudi za zmanjšanje pristranskosti neutežene ocene (Kalton & Vehovar, 2001, str. 111). 

Podobno kot pri neuteženih podatkih ocenimo testno statistiko:

$$
T_w = \frac{\hat{\mu}_{w1} - \hat{\mu}_{w2}}{\sqrt{var(\hat{\mu}_{w1}) + var(\hat{\mu}_{w2})}} 
$$
ki je približno porazdeljena po $t$ porazdelitvi z $\nu_w$ stopinjami prostosti (df) izračunanimi po naslednji formuli:

$$
\nu_w \approx \frac{\left(var(\hat{\mu}_{w1}) + var(\hat{\mu}_{w2})\right)^2}{\left(var(\hat{\mu}_{w1})\right)^{2} /\left(n_{1}-1\right)+\left(var(\hat{\mu}_{w2})\right)^{2} /\left(n_{2}-1\right)}
$$

```{r, eval=FALSE}
d = data.frame(uc = c(2,5,6,8,3,7,6,3,5,2),
               sm = c(1,2,3,3,2,4,4,2,3,2),
               utez = c(12,6,4,4,6,3,3,6,4,6))
d$u <- d$uc * d$utez

up = weighted.mean(d$uc, w = d$utez)

(var(d$u)*10 + up^2*var(d$utez)*10-2*up*10*cov(d$u, d$utez))/(sum(d$utez)^2)

cor(d$uc, d$utez)
cor(d$u, d$utez)
```


# Izračuni za opisne (nominalne) spremnljivke

## Neuteženi podatki

Imamo nominalno spremenljivko s $k$ kategorijami. Delež je pravzaprav povprečje binomsko porazdeljene slučajne spremenljivke (lahko zavzame vrednosti 0 in 1, $\sim \frac{1}{n}Binom(n,p)$). V našem primeru taka spremenljivka zavzame vrednost 1, če je v $k$-ti kategoriji in 0, če ni (skupaj $n$ vrednosti). Ne želimo preverjati ničelne domneve, da so hkrati deleži vseh kategorij enaki ($H_0:p_1= p_2=\ ...\ = p_k$), temveč želimo preveriti ničelno domnevo, da je delež v $k$-ti kategoriji v prvem vzorcu (skupini) enak deležu v isti kategoriji v drugem vzorcu (skupini) ($H_0:p_{1}=p_{2}$).

Ker sta vzorca neodvisna, velja $Var(p_{1}-p_{2})=\frac{p_1(1-p_1)}{n_1-1} + \frac{p_2(1-p_2)}{n_2-1}$. Uporabili smo nepristransko cenilko za elementarno varianco binomsko porazdeljene spremenljivke, ki je $Var = \frac{n}{n-1} p(1-p)$, iz tega potem izhaja, da je vzorčna varianca $Var(p)=\frac{np(1-p)/n-1}{n} = \frac{p(1-p)}{n-1}$. 

Normalna porazdelitev začne precej dobro aproksimirati binomsko, ko velja pravilo čez palec $np>5$ in $n(1-p)>5$ (pri bolj ekstremnih deležih je potreben večji vzorec). Na vzorcu ocenimo testno statistiko:

\begin{equation}
Z = \frac{\hat{p}_1 - \hat{p}_2}{\sqrt{\frac{\hat{p}_1(1-\hat{p}_1)}{n_1-1} + \frac{\hat{p}_2(1-\hat{p}_2)}{n_2-1}}} 
\end{equation}
ki je ob izpolnjenih pogojih (dovolj velik vzorec) porazdeljena približno po standardni normalni ($z$) porazdelitvi. Ta izraz vrne identično vrednost kot enačba (1).

Formalno gledano ta testna statistika ni porazdeljena kot $t$ porazdelitev (ocenimo le en parameter, ne dva), vendar bomo pri poročanju p vrednosti in IZ uporabili $t$ porazdelitev, ker bomo tako bolj konzervativni in tako upamo, da bo napaka prve vrste res $\leq \alpha$ (predvsem pri manjših vzorcih, ko ima $t$ porazdelitev širše repe kot normalna in bo dala višje p vrednosti in širše IZ).

## Uteženi podatki

Postopamo isto kot v poglavju za številske spremenljivke.


```{r, eval=FALSE}
t1 = sample(0:1, 100, TRUE, c(0.3, 0.7))
t2 = sample(0:1, 100, TRUE, c(0.3, 0.7))

wtd_t_test(t1, t2)

p1 = mean(t1)
p2 = mean(t2)

(p2-p1)/(sqrt(p1*(1-p1)/(100-1) + p2*(1-p2)/(100-1)))
```

# Simulacije (izračun vzorčne variance)

V izdelavi...

```{r, eval=FALSE}
library(tidyverse)
library(anesrake)

generate_data <- function(n, beta0 = 10, beta1 = 3, sigma = 2, pA){
  data <- data.frame(row.names = seq_len(n))
  
  data$spremenljivka_X <- sample(1:4, size = n, replace = TRUE, prob = c(0.4, 0.2, 0.2, 0.2))
  
  # vrednosti slučajnih napak
  epsilon <- rnorm(n, mean = 0, sd = sigma)
  
  data$spremenljivka_Y <- (beta0 + beta1*data$spremenljivka_X + epsilon)
  
  data$spremenljivka_A <- sample(x = 0:1, size = n, replace = TRUE, prob = c(1-pA, pA))
  
  data$spremenljivka_X <- as.factor(data$spremenljivka_X)
  data$spremenljivka_A <- as.factor(data$spremenljivka_A)
  
  return(data)
}


spremenljivka_X_target <- c(0.2, 0.2, 0.2, 0.4)
names(spremenljivka_X_target) <- 1:4

spremenljivka_A_target <- c(0.5, 0.5)
names(spremenljivka_A_target) <- 0:1

targets <- list(spremenljivka_X_target, spremenljivka_A_target)

names(targets) <- c("spremenljivka_X", "spremenljivka_A")

n <- 1000

caseid <- 1:n

n_sim <- 1000

results <- matrix(data = rep(NA, 12*n_sim), ncol = 12,
                  dimnames = list(NULL,
                                  c("povp", "utezeno_povp", "cor", "var_utezi", "se2/n", "se_w2/n", "se_cov", "se_VIF", "se_w", "cov", "bias", "var_cov")))

for(i in 1:n_sim){
  data <- generate_data(n = n, beta0 = 20, beta1 = -10, sigma = 1, pA = 0.6)

  # RAKING
  weights <- anesrake::anesrake(targets, data, caseid = caseid, type = "nolim")$weightvec
  
  # SHRANIMO REZULTATE
  # neuteženo povprečje
  results[i,1] <- mean(data$spremenljivka_Y)
  # uteženo povprečje
  mu <- weighted.mean(x = data$spremenljivka_Y, w = weights)
  results[i,2] <- mu
  # korelacija med utežmi in spremenljivko Y
  results[i,3] <- cor(data$spremenljivka_Y, weights)
  
  # varianca uteži
  results[i,4] <- var(weights)
  
  # se^2/n
  results[i,5] <- var(data$spremenljivka_Y)/n
  # se_w^2/n
  results[i,6] <- Hmisc::wtd.var(x = data$spremenljivka_Y, weights = weights)/n
  # se_cov
  u <- weights * data$spremenljivka_Y
  results[i,7] <- (n * var(u) + mu^2 * n * var(weights) - 2 * mu * n * cov(u, weights))/(sum(weights)^2)
  # se VIF
  results[i,8] <- (var(data$spremenljivka_Y)/n) * (1 + var(weights))
  # se wiki
  results[i,9] <- (1/sum(weights)^2) * sum(weights^2 * (data$spremenljivka_Y - mu)^2) 
  # boot
  # boot_mu <- vector("numeric", 10L)
  # for(j in 1:10){
  #   data_boot <- data[sample(1:n, n, replace=TRUE),]
  #   weights_boot <- anesrake::anesrake(targets, data_boot, caseid = caseid, type = "nolim")$weightvec
  #   boot_mu[j] <- weighted.mean(x = data_boot$spremenljivka_Y, w = weights_boot)
  # }
  # results[i,10] <-   ((cov(data$spremenljivka_Y^2, weights^2) + mean(data$spremenljivka_Y^2)*mean(weights^2)) - (cov(data$spremenljivka_Y, weights) + mean(data$spremenljivka_Y)*mean(weights))^2)/n
  
  results[i,10] <- cov(data$spremenljivka_Y, weights)
  results[i,11] <- mu - mean(data$spremenljivka_Y)
  results[i,12] <- (1/n^2) * (cov(data$spremenljivka_Y^2, weights^2) + (var(data$spremenljivka_Y) + mean(data$spremenljivka_Y)^2) * (var(weights) + mean(weights)^2) - (cov(data$spremenljivka_Y,weights) + mean(data$spremenljivka_Y)*mean(weights))^2)
}



hist(results[,1], breaks = 50, freq = FALSE)
hist(results[,2], breaks = 50, freq = FALSE)

var(results[,1])
var(results[,2])
mean(results[,5])
mean(results[,6])
mean(results[,7])
mean(results[,8])
mean(results[,9])
mean(results[,12])

# bias je praktično enak kovarianci med utežjo in spr.
mean(results[,10])
mean(results[,11])

# korelacija med utežmi in ciljno spremenljivko
mean(results[,3])



m = replicate(1000, mean(rnorm(100, 3, 10)))
hist(m, breaks = 100, freq = FALSE)
curve(dnorm(x, mean(m), sd(m)), add = TRUE)


m = replicate(1000, mean(runif(100, 3, 10))/mean(runif(100, 10, 13)))
hist(m, breaks = 100, freq = FALSE)
curve(dnorm(x, mean(m), sd(m)), add = TRUE)



########################################
w <- weights
y <- w
x <- data$spremenljivka_Y
u <- data$spremenljivka_Y*w
muu <- mean(u)
muw <- mean(w)
mu1 <- weighted.mean(x,w)

(muu^2/muw^2)*((var(u)/muu^2)-(2*(cov(u,w)/(muu*muw))) + var(w)/muw^2)

(n * var(u, na.rm = TRUE) + mu1^2 * n * var(w, na.rm = TRUE) - 2 * mu1 * n * cov(u, w, use = "complete.obs"))/(sum(w, na.rm = TRUE)^2)

(var(u, na.rm = TRUE) + mu1^2 * var(w, na.rm = TRUE) - 2 * mu1 * cov(u, w, use = "complete.obs"))/(sum(w, na.rm = TRUE))


(1/n^2) * (cov(x^2, y^2) + (var(x) + mean(x)^2) * (var(y) + mean(y)^2) - (cov(x,y) + mean(x)*mean(y))^2)
```

